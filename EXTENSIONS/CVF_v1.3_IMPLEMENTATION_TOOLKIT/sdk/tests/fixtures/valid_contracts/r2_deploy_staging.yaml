name: Deploy to Staging
version: "2.0.0"
metadata:
  description: "R2 - Deploy to staging environment"
  author: "test-suite"
  created_at: "2026-01-29"

risk_level: R2
human_required: true

input_schema:
  type: object
  properties:
    service_name:
      type: string
      description: "Service to deploy"
    image_tag:
      type: string
      description: "Docker image tag"
      pattern: "^[a-z0-9.-]+$"
    environment:
      type: string
      enum: ["staging", "canary"]
    approval_ticket:
      type: string
      description: "Ticket number for approval"
  required: ["service_name", "image_tag", "approval_ticket"]

output_schema:
  type: object
  properties:
    deployment_id:
      type: string
    status:
      type: string
      enum: ["in_progress", "completed", "failed"]
    rollout_percentage:
      type: integer
    health_check:
      type: object
      properties:
        passed:
          type: boolean
        errors:
          type: array
          items:
            type: string

permissions:
  scope: "deployment:staging"
  required_approval: true
  approval_roles: ["platform-engineer", "devops-lead"]
  approval_timeout_minutes: 60

execution:
  handler: "deploy_staging_handler"
  timeout_seconds: 300
  rollback_policy:
    auto_rollback_on_health_check_fail: true
    keep_previous_replica: true

audit:
  log_level: "WARNING"
  fields: ["deployment_id", "status", "approval_ticket", "health_check"]
