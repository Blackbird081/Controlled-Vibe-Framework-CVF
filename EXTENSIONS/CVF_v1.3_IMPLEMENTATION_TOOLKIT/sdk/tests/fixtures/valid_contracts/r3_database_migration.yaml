name: Production Database Migration
version: "1.0.0"
metadata:
  description: "R3 - System-wide database schema change"
  author: "test-suite"
  created_at: "2026-01-29"

risk_level: R3
human_required: true

input_schema:
  type: object
  properties:
    migration_id:
      type: string
      description: "Migration identifier"
      pattern: "^MAINT_[0-9]{8}$"
    sql_script:
      type: string
      description: "SQL migration script"
    rollback_script:
      type: string
      description: "SQL rollback script"
    data_backup_location:
      type: string
      description: "Where backup is stored"
    maintenance_window:
      type: object
      properties:
        start_utc:
          type: string
          format: "date-time"
        duration_minutes:
          type: integer
  required: ["migration_id", "sql_script", "rollback_script", "data_backup_location"]

output_schema:
  type: object
  properties:
    migration_id:
      type: string
    status:
      type: string
      enum: ["approved", "executed", "rolled_back", "failed"]
    execution_time_seconds:
      type: integer
    affected_records:
      type: integer
    post_execution_audit:
      type: object
      properties:
        row_count_verified:
          type: boolean
        integrity_check_passed:
          type: boolean

permissions:
  scope: "database:production:*"
  required_approval: true
  approval_roles: ["cto", "database-admin"]
  approval_timeout_minutes: 120
  require_change_control_ticket: true

human_review_checkpoints:
  - stage: "pre_execution"
    required: true
    timeout_minutes: 30
  - stage: "post_execution"
    required: true
    timeout_minutes: 60

execution:
  handler: "database_migration_handler"
  timeout_seconds: 600
  transaction_isolation: "SERIALIZABLE"
  connection_pool:
    max_connections: 2
  rollback_policy:
    auto_rollback_on_error: false
    manual_approval_required: true

audit:
  log_level: "CRITICAL"
  log_to: ["siem", "audit_database", "slack_channel"]
  fields: ["migration_id", "status", "affected_records", "execution_time", "integrity_check"]
  immutable: true
