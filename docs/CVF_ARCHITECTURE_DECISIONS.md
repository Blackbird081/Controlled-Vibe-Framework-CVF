# CVF Architecture Decisions

> **Location:** `docs/CVF_ARCHITECTURE_DECISIONS.md`
> **Format:** See `governance/toolkit/05_OPERATION/CVF_ADR_GUARD.md`
> **Rule:** Every entry must correspond to a commit using a trigger pattern (`feat(governance):`, `feat(domain):`, etc.)

---

## ADR-001: Domain Strategy — Job Function over User Type

| Field | Value |
|---|---|
| Date | 2026-02-27 |
| Status | Active |
| Related commits | `c91a8ff`, `964bc08` |

### Context
During skills intake from the CVF-Compatible Skills source archive, 7 new skills were initially placed under a domain called `non_coder_workflow`. This domain was named after a *user type* (non-coders), not a *job function*. This created a structural inconsistency with all existing CVF domains which are named after functional areas (`app_development`, `product_ux`, `finance_analytics`...).

### Decision
**Domains MUST be named after job functions, never user types or personas.**

The `non_coder_workflow` domain was dissolved. Its 7 skills were migrated:
- 6 skills → `app_development`
- 1 skill → `product_ux`

### Rationale
- User types are volatile (a "non-coder" today may learn to code tomorrow)
- Job functions are stable and map to real-world workflows
- All existing CVF domains follow the job-function pattern — consistency is critical for AI skill routing
- A `non_coder_workflow` domain would create a second classification axis, complicating the skill index

### Consequences
- All existing and future domains must pass the test: *"Is this a job function?"*
- The `SKILL_INTAKE_GOVERNANCE.md` disqualification rules explicitly ban user-type domain names
- `build-skill-index.js` domain maps were updated to remove `non_coder_workflow`

### Related Files
- `governance/toolkit/05_OPERATION/SKILL_INTAKE_GOVERNANCE.md`
- `EXTENSIONS/CVF_v1.6_AGENT_PLATFORM/cvf-web/scripts/build-skill-index.js`
- `EXTENSIONS/CVF_v1.5.2_SKILL_LIBRARY_FOR_END_USERS/app_development/` (migrated skills)

---

## ADR-002: Skill Content Language — English Only

| Field | Value |
|---|---|
| Date | 2026-02-27 |
| Status | Active |
| Related commits | `36195bd` |

### Context
8 new skills were imported from the CVF-Compatible Skills archive. All were written in Vietnamese. The existing 141 skills in the CVF library are written in English. Skills function as governance instructions for AI/Agent execution — they define constraints, validation hooks, and behavioral rules that the AI reads and follows.

### Decision
**All skill file content MUST be written in English.**

All 8 imported skills were fully translated to English (v1.1.0). This applies to all future skill additions.

### Rationale
- AI/Agent models process English governance instructions more consistently across different AI providers
- Vietnamese-only skills create a split codebase that is difficult to maintain
- The CVF skill library is designed to be shareable and AI-agnostic — English maximizes compatibility
- Vietnamese may still appear in *user-facing output* (e.g. `USER_GUIDE.md` generated by Auto Documentation skill), but the skill governance layer itself must be English

### Consequences
- `SKILL_INTAKE_GOVERNANCE.md` mandates English as a disqualification rule
- Existing 141 skills: already in English — no action needed
- New or imported skills: must be translated BEFORE being placed in the library
- The filename `05_auto_documentation_vn.skill.md` retains `_vn` in the name to indicate the skill *generates* Vietnamese output, not that the skill itself is in Vietnamese

### Related Files
- `governance/toolkit/05_OPERATION/SKILL_INTAKE_GOVERNANCE.md` (Language Rule section)
- `EXTENSIONS/CVF_v1.5.2_SKILL_LIBRARY_FOR_END_USERS/app_development/01_vibe_to_spec.skill.md` (and 7 others)

---

## ADR-003: Skill Intake Governance — Formal Policy Required

| Field | Value |
|---|---|
| Date | 2026-02-27 |
| Status | Active |
| Related commits | `36195bd` |

### Context
During the CVF-Compatible Skills intake, multiple structural errors occurred that had to be corrected retroactively:
1. Skills were placed in a wrong domain (`non_coder_workflow` instead of `app_development`)
2. Skills were written in Vietnamese instead of English
3. Skills had no corresponding Template entries in the Web UI
4. UAT binding paths referenced the old wrong domain

These errors were only caught during manual review, not by any automated gate. Without a formal intake process, every new skill addition risks repeating the same mistakes.

### Decision
**A formal Skill Intake Governance policy is mandatory for all new skills.**

Created `governance/toolkit/05_OPERATION/SKILL_INTAKE_GOVERNANCE.md` with:
- 5 intake criteria (all must pass before intake begins)
- Auto-reject disqualification rules
- Domain assignment rules with priority order
- Decision matrix (INTAKE / REJECT / HOLD)
- 15-section mandatory checklist
- Template Bridge Requirement (every skill must have a Web UI template)
- Full 7-step governance pipeline

### Rationale
- Without a formal process, intake quality depends entirely on the reviewer's memory
- The 5 intake criteria catch structural errors *before* files are created
- The disqualification rules explicitly prevent recurrence of the exact errors that occurred in this intake
- The Template Bridge Requirement ensures no skill is "invisible" to end-users via the Web UI

### Consequences
- Any future skill addition (internal or external) must follow this policy
- `CONTINUOUS_GOVERNANCE_LOOP.md` drift triggers must include "policy added without ADR"
- `CVF_ADR_GUARD.md` policies themselves must be recorded as ADRs (this entry demonstrates compliance)
- The CVF_SKILL_INTAKE_RECORD.md (bare-bones template) is superseded in practice by SKILL_INTAKE_GOVERNANCE.md for process; the record file remains for individual skill sign-offs

### Related Files
- `governance/toolkit/05_OPERATION/SKILL_INTAKE_GOVERNANCE.md`
- `governance/toolkit/05_OPERATION/CVF_SKILL_INTAKE_RECORD.md`
- `EXTENSIONS/CVF_v1.6_AGENT_PLATFORM/cvf-web/src/lib/skill-template-map.ts`
- `EXTENSIONS/CVF_v1.6_AGENT_PLATFORM/cvf-web/src/lib/templates/development.ts`
- `EXTENSIONS/CVF_v1.6_AGENT_PLATFORM/cvf-web/src/lib/templates/product.ts`

---

## ADR-004: ADR Guard — Architecture Decision Traceability Policy

| Field | Value |
|---|---|
| Date | 2026-02-27 |
| Status | Active |
| Related commits | *(this commit)* |

### Context
CVF already had Bug Guard and Test Guard for documenting fixes and test results. However, architectural and strategic decisions (core value corrections, domain strategy, governance policy additions) were only recorded in git commit messages — which capture *what* changed but not *why*. This created a traceability gap for future contributors and AI agents needing to understand design rationale.

### Decision
**Architectural and strategic decisions require ADR entries in `docs/CVF_ARCHITECTURE_DECISIONS.md`.**

Created `governance/toolkit/05_OPERATION/CVF_ADR_GUARD.md` defining:
- Trigger patterns: `feat(core-value):`, `feat(governance):`, `feat(domain):`, `refactor(arch):`, `docs(policy):`
- Mandatory ADR fields: Context, Decision, Rationale, Consequences, Related commits/files
- ADR lifecycle: Active / Superseded / Revoked (never delete)
- Integration with Continuous Governance Loop as a drift trigger

### Rationale
- Bug Guard = *what broke*; Test Guard = *what was tested*; ADR = *why the architecture is this way*
- These are orthogonal concerns requiring separate documentation
- Commit messages are discoverable only if you know to look — ADRs are a first-class searchable document
- CVF's governance loop explicitly requires "Decision Traceability" (Section 7 of CONTINUOUS_GOVERNANCE_LOOP.md) — ADR Guard operationalizes this requirement

### Consequences
- All future architecture/strategy decisions must trigger an ADR
- `CONTINUOUS_GOVERNANCE_LOOP.md` updated: ADR-less architecture decision = drift trigger
- Historical decisions (ADR-001, 002, 003) backfilled in this same commit
- The 4 guard types (Bug, Test, Skill Intake, ADR) together provide complete traceability coverage

### Related Files
- `governance/toolkit/05_OPERATION/CVF_ADR_GUARD.md`
- `governance/toolkit/05_OPERATION/CONTINUOUS_GOVERNANCE_LOOP.md`
- `docs/CVF_ARCHITECTURE_DECISIONS.md` (this file)

---

## ADR-005: Hypervisor Mode Integration — Extract, Don't Duplicate

| Field | Value |
|---|---|
| Date | 2026-02-28 |
| Status | Active |
| Related commits | *(this commit)* |

### Context
A `CVF_Hypervisor Mode` folder (30 files) was created as a prototype for an AI Safety Hypervisor concept — a runtime layer sitting between LLM output and system execution. Quality evaluation revealed that ~60% of its code duplicated existing v1.7.x modules (risk scorer, policy engine, decision gate, dashboard, ledger) at lower quality (0 tests, in-memory only, no auth/DI), while ~40% introduced genuinely new concepts not found anywhere in CVF.

### Decision
**Extract unique value into a new extension; discard duplicates; delete the original folder.**

1. **Version**: v1.7.3 (PATCH extending v1.7.1, following established pattern v1.7 → v1.7.1 → v1.7.2 → v1.7.3)
2. **Name**: Runtime Adapter Hub
3. **Layer**: AI Safety Layer (Layer 3)
4. **Location**: `EXTENSIONS/CVF_v1.7.3_RUNTIME_ADAPTER_HUB/`

**Kept** (13 files — unique value):
- `contracts/` — 5 universal adapter interfaces (LLM, Runtime, Tool, Memory, Policy)
- `adapters/` — 4 runtime implementations (OpenClaw, PicoClaw, ZeroClaw, Nano) + shared base
- `explainability/` — Human-readable action explanations (EN/VI)
- `policy/` — Natural language policy parser
- `risk_models/` — 4 JSON risk configuration files

**Discarded** (14 files — duplicated v1.7.x at lower quality):
- `core/` (5 of 6 files) — v1.7.1 has superior risk engine, policy registry, state machine
- `dashboard/` (4 files) — v1.7.2 has complete React Safety Dashboard
- `ledger/` (4 files) — v1.7.1 has Prisma-backed journal and snapshots
- `index.ts` — Demo file that did not use the core pipeline

**Deleted**: `CVF_Hypervisor Mode/` folder removed entirely after extraction.

### Rationale
- Maintaining parallel code would create a weaker second codebase competing with production-grade v1.7.x
- The unique innovations (runtime adapter contracts, NLP policy, explainability) are genuinely new capabilities that extend CVF without overlapping
- v1.7.3 as a PATCH version correctly signals "sub-extension of v1.7.1" without breaking backward compatibility
- The `Thong_tin.md` competitive analysis was preserved as `docs/CVF_HYPERVISOR_STRATEGY.md`

### Consequences
- Future runtime adapter additions must implement the `RuntimeAdapter` contract in `contracts/`
- The explainability layer can be integrated into v1.7.2 Safety Dashboard for NL action descriptions
- 41 unit tests validate all new modules (contracts, adapters, explainability, NLP parser)
- `docs/VERSIONING.md` and `docs/VERSION_COMPARISON.md` updated with v1.7.3

### Related Files
- `EXTENSIONS/CVF_v1.7.3_RUNTIME_ADAPTER_HUB/` (new extension)
- `docs/VERSIONING.md` (updated)
- `docs/VERSION_COMPARISON.md` (updated)
- `docs/CVF_HYPERVISOR_STRATEGY.md` (moved from Hypervisor Mode)
- `.gitignore` (still contains `CVF_Hypervisor Mode/` entry — harmless)

---

## ADR-006: Mandatory Skill Preflight Before Build/Code

| Field | Value |
|---|---|
| Date | 2026-03-01 |
| Status | Active |
| Related commits | *(this commit)* |

### Context
CVF governance already required skill mapping and phase/risk compliance, but project-level execution often entered Phase C directly from design artifacts without an explicit pre-code skill check. This created an enforcement gap: the rule existed conceptually, but was easy to skip during real delivery.

### Decision
**Skill Preflight is now a mandatory gate before any Build/Execute action that modifies artifacts.**

Skill Preflight requires:
1. Identify intended skill(s) before coding.
2. Verify each skill has valid mapping for current phase and risk.
3. Declare selected skill IDs in trace before code/file modification.
4. If no suitable skill exists, STOP and create intake/escalation record.

### Rationale
- Converts implicit skill governance into explicit operational behavior.
- Aligns policy, bootstrap, command contract, and phase gate in one consistent rule.
- Prevents "policy exists but execution bypasses" failure mode.
- Improves auditability by requiring concrete pre-build evidence.

### Consequences
- Phase B→C gate now fails if Skill Preflight is missing.
- `CVF:EXECUTE` requires Skill Preflight declaration artifact.
- Agent UAT now includes a mandatory refusal test for missing Skill Preflight in Build.
- This change applies framework-wide to future projects, not only current repos.

### Related Files
- `governance/toolkit/02_POLICY/CVF_MASTER_POLICY.md`
- `governance/toolkit/01_BOOTSTRAP/CVF_AGENT_SYSTEM_PROMPT.md`
- `governance/toolkit/01_BOOTSTRAP/CVF_VSCODE_BOOTSTRAP.md`
- `v1.0/governance/PHASE_C_GATE.md`
- `v1.1/interface/CVF_COMMANDS.md`
- `governance/toolkit/04_TESTING/CVF_AGENT_UAT.md`
- `governance/toolkit/04_TESTING/CVF_AGENT_UAT_TEST.yaml`
- `governance/toolkit/04_TESTING/CVF_AGENT_UAT_TEST.json`
- `docs/concepts/4-phase-process.md`
- `docs/concepts/governance-model.md`

---

## ADR-007: Standard Skill Preflight Record Template + Pilot Rollout

| Field | Value |
|---|---|
| Date | 2026-03-01 |
| Status | Active |
| Related commits | *(this commit)* |

### Context
ADR-006 made Skill Preflight mandatory before Build/Execute, but teams still needed a concrete reusable artifact template and project-level pilot evidence to avoid inconsistent adoption.

### Decision
**Introduce a standard `SKILL_PREFLIGHT_RECORD` template at framework level and rollout pilot adoption in `XD_App` and `Mini_Game`.**

1. Added canonical template:
   - `governance/toolkit/03_CONTROL/SKILL_PREFLIGHT_RECORD.md`
2. Added active mapping record for governance skill used by preflight:
   - `governance/toolkit/03_CONTROL/CVF_CORE_SKILL_PREFLIGHT_GOVERNANCE.mapping.md`
3. Applied pilot in 2 projects with local records + gate/checklist integration:
   - `XD_App/DOCUMENTS/SKILL_PREFLIGHT_RECORD.md`
   - `Mini_Game/CVF_DOCS/SKILL_PREFLIGHT_RECORD.md`

### Rationale
- Turns policy into an operational artifact teams can execute consistently.
- Provides evidence-first governance for audit and root-cause analysis.
- Validates framework rule in real project contexts before broader rollout.

### Consequences
- Future projects can adopt Skill Preflight without inventing their own format.
- Project documentation now contains explicit pre-code governance evidence.
- Decision traces for rollout are logged in project-level decision/history files.

### Related Files
- `governance/toolkit/03_CONTROL/SKILL_PREFLIGHT_RECORD.md`
- `governance/toolkit/03_CONTROL/CVF_CORE_SKILL_PREFLIGHT_GOVERNANCE.mapping.md`
- `XD_App/DOCUMENTS/SKILL_PREFLIGHT_RECORD.md`
- `XD_App/DOCUMENTS/DECISIONS.md`
- `Mini_Game/CVF_DOCS/SKILL_PREFLIGHT_RECORD.md`
- `Mini_Game/CVF_DOCS/DECISIONS.md`
- `Mini_Game/PROJECT_ARCHIVE/CHANGE_HISTORY.md`

---

## ADR-008: Web UI Skill Preflight Integration Baseline (Pre-Upgrade Snapshot)

| Field | Value |
|---|---|
| Date | 2026-03-01 |
| Status | Active |
| Related commits | *(this commit)* |

### Context
ADR-006 and ADR-007 established mandatory Skill Preflight governance and a standard preflight record artifact. Before implementing Web UI upgrades, a framework-level baseline snapshot is required to capture actual integration state and avoid "policy declared but not enforced in runtime" drift.

### Decision
**Record the current Web UI integration state as a formal baseline: Skill Preflight is only partially integrated in `cvf-web` and is not yet enforced as a hard pre-code gate.**

Baseline findings:
1. Framework policy/docs include mandatory Skill Preflight and `SKILL_PREFLIGHT_RECORD` requirements.
2. Web UI phase-gate checklist (`Build`) does not contain an explicit Skill Preflight item.
3. Client/server execution enforcement currently checks budget/spec/risk, but not Skill Preflight evidence.
4. Governance evaluate request schema does not require Skill Preflight declaration fields.
5. Skill library/planner and template-skill bridge exist, but currently operate as support/discovery, not as mandatory pre-build gate controls.

### Rationale
- Preserves an auditable "before upgrade" reference for CVF governance evolution.
- Prevents ambiguity when validating whether upcoming implementation truly closes the enforcement gap.
- Enables post-upgrade regression checks against a documented baseline instead of ad-hoc memory.

### Consequences
- This ADR becomes the authoritative baseline for Web UI Skill Preflight upgrade scope.
- Upgrade acceptance criteria must demonstrate movement from partial integration to enforced gate behavior.
- Future audits can trace exactly why and where Web UI governance changes were introduced.

### Related Files
- `docs/concepts/governance-model.md`
- `docs/CVF_ARCHITECTURE_DECISIONS.md`
- `EXTENSIONS/CVF_v1.6_AGENT_PLATFORM/cvf-web/src/lib/cvf-checklists.ts`
- `EXTENSIONS/CVF_v1.6_AGENT_PLATFORM/cvf-web/src/components/PhaseGateModal.tsx`
- `EXTENSIONS/CVF_v1.6_AGENT_PLATFORM/cvf-web/src/lib/enforcement.ts`
- `EXTENSIONS/CVF_v1.6_AGENT_PLATFORM/cvf-web/src/app/api/execute/route.ts`
- `EXTENSIONS/CVF_v1.6_AGENT_PLATFORM/cvf-web/src/types/governance-engine.ts`
- `EXTENSIONS/CVF_v1.6_AGENT_PLATFORM/cvf-web/src/app/api/governance/evaluate/route.ts`
- `EXTENSIONS/CVF_v1.6_AGENT_PLATFORM/cvf-web/src/lib/skill-template-map.ts`
- `EXTENSIONS/CVF_v1.6_AGENT_PLATFORM/cvf-web/src/lib/skill-planner.ts`

---

## ADR-009: Web UI Skill Preflight Enforcement Upgrade (Framework-Level Integration)

| Field | Value |
|---|---|
| Date | 2026-03-01 |
| Status | Active |
| Related commits | *(this commit)* |

### Context
ADR-008 captured a pre-upgrade baseline showing that Web UI governance had phase/risk/spec controls but did not enforce Skill Preflight as a hard gate for Build/Execute actions. This left a runtime gap between framework policy and actual execution behavior.

### Decision
**Upgrade `cvf-web` to enforce Skill Preflight in Build/Execute flows, and add test evidence for the new controls.**

Implementation scope:
1. Added mandatory Skill Preflight item to Build checklist in phase gate UI.
2. Extended enforcement model with Skill Preflight state (`required/declared/source`).
3. Added blocking rule: Build/Execute actions are blocked if Skill Preflight declaration is missing.
4. Extended execution/governance request schemas with `skill_preflight` metadata.
5. Added API route validation for governance evaluate calls in BUILD phase.
6. Wired chat and multi-agent runtime enforcement with phase-aware Skill Preflight requirements.
7. Added/updated tests for checklist, enforcement (sync/async), execute route, and governance evaluate route.

### Rationale
- Closes the "policy exists but runtime bypasses" gap identified in ADR-008.
- Converts Skill Preflight from documentation-only requirement into enforceable platform behavior.
- Preserves compatibility by accepting declaration via explicit fields or recognized content markers.

### Consequences
- Build/Execute requests in Web UI now require Skill Preflight evidence before execution.
- API consumers targeting BUILD evaluation must provide declared Skill Preflight metadata.
- Test coverage for upgraded modules is expanded; remaining heavy hook suite may require higher memory in local environments.

### Related Files
- `EXTENSIONS/CVF_v1.6_AGENT_PLATFORM/cvf-web/src/lib/cvf-checklists.ts`
- `EXTENSIONS/CVF_v1.6_AGENT_PLATFORM/cvf-web/src/lib/cvf-checklists.test.ts`
- `EXTENSIONS/CVF_v1.6_AGENT_PLATFORM/cvf-web/src/lib/enforcement.ts`
- `EXTENSIONS/CVF_v1.6_AGENT_PLATFORM/cvf-web/src/lib/enforcement.test.ts`
- `EXTENSIONS/CVF_v1.6_AGENT_PLATFORM/cvf-web/src/lib/enforcement-async.test.ts`
- `EXTENSIONS/CVF_v1.6_AGENT_PLATFORM/cvf-web/src/lib/ai/types.ts`
- `EXTENSIONS/CVF_v1.6_AGENT_PLATFORM/cvf-web/src/types/governance-engine.ts`
- `EXTENSIONS/CVF_v1.6_AGENT_PLATFORM/cvf-web/src/app/api/execute/route.ts`
- `EXTENSIONS/CVF_v1.6_AGENT_PLATFORM/cvf-web/src/app/api/execute/route.test.ts`
- `EXTENSIONS/CVF_v1.6_AGENT_PLATFORM/cvf-web/src/app/api/governance/evaluate/route.ts`
- `EXTENSIONS/CVF_v1.6_AGENT_PLATFORM/cvf-web/src/app/api/governance/evaluate/route.test.ts`
- `EXTENSIONS/CVF_v1.6_AGENT_PLATFORM/cvf-web/src/lib/hooks/useAgentChat.ts`
- `EXTENSIONS/CVF_v1.6_AGENT_PLATFORM/cvf-web/src/lib/hooks/useAgentChat.test.ts`
- `EXTENSIONS/CVF_v1.6_AGENT_PLATFORM/cvf-web/src/components/MultiAgentPanel.tsx`
